<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ASAHE | ASA-Bot Preview</title>
    <meta name="description" content="ASA-Bot ASAHEâ€™s virtual assistant for courses, admissions, fees and student support.">
    <link rel="icon" type="image/png" href="assets/asa-logo.png" sizes="32x32">
    <link rel="apple-touch-icon" href="assets/asa-logo.png">
    <meta name="theme-color" content="#002E5D">
    <style>
      :root {
        --asa-navy: #002E5D;
        --asa-gold: #D4AF37;
        --asa-teal: #007B7F;
        --asa-bg: #F7F7F7;
        --asa-text: #1E2B3A;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
        color: var(--asa-text);
        background: var(--asa-bg);
        line-height: 1.5;
      }
      header {
        background: var(--asa-navy);
        color: #fff;
        padding: 24px 16px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .brand img {
        width: 44px;
        height: 44px;
        object-fit: contain;
      }
      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 24px 16px;
      }
      .title {
        margin: 0 0 4px 0;
        font-size: 28px;
        font-weight: 700;
      }
      .subtitle {
        margin: 0;
        opacity: 0.9;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 900px) {
        .grid { grid-template-columns: 1.2fr 1fr; }
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }
      .chip {
        background: #fff;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 999px;
        padding: 10px 14px;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .chip:hover { border-color: var(--asa-teal); color: var(--asa-teal); }
      .cta {
        display: inline-block;
        background: var(--asa-gold);
        color: #1E2B3A;
        font-weight: 600;
        padding: 12px 16px;
        border-radius: 10px;
        text-decoration: none;
        margin-top: 16px;
      }
      .actions {
        display: grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        gap: 10px;
      }
      .btn {
        background: #fff;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 10px;
        padding: 12px 14px;
        cursor: pointer;
        text-align: center;
        transition: all .15s ease;
      }
      .btn:hover { border-color: var(--asa-navy); color: var(--asa-navy); }
      .btn.primary { background: var(--asa-teal); color: #fff; border-color: var(--asa-teal); }

      /* Modal */
      .modal-backdrop {
        position: fixed; inset: 0; background: rgba(0,0,0,0.35);
        display: none; align-items: center; justify-content: center; padding: 16px;
      }
      .modal {
        background: #fff; border-radius: 12px; width: 100%; max-width: 560px; padding: 18px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      }
      .modal h3 { margin: 6px 0 8px 0; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .row.single { grid-template-columns: 1fr; }
      label { font-size: 14px; margin-top: 8px; display: block; }
      input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #E5E7EB; border-radius: 8px; }
      .help { color: #6B7280; font-size: 12px; }
      .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
      .hidden { display: none !important; }
      .toast { position: fixed; right: 16px; bottom: 16px; background: #1E2B3A; color: #fff; padding: 10px 12px; border-radius: 8px; opacity: 0; transform: translateY(6px); transition: all .2s ease; z-index: 9999; }
      .toast.show { opacity: 1; transform: translateY(0); }
      
      /* Voice Assistant */
      .voice-panel {
        position: fixed; bottom: 20px; left: 20px; right: 20px; max-width: 500px; z-index: 9000;
        background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        padding: 20px; display: none;
      }
      .voice-panel.active { display: block; }
      .voice-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
      .voice-header h4 { margin: 0; color: var(--asa-navy); }
      .voice-status { font-size: 12px; color: #6B7280; }
      .voice-status.listening { color: var(--asa-teal); font-weight: 600; }
      .mic-container { display: flex; align-items: center; justify-content: center; padding: 24px; }
      .mic-btn {
        width: 80px; height: 80px; border-radius: 50%; border: none; cursor: pointer;
        background: var(--asa-navy); color: #fff; font-size: 32px; transition: all .3s ease;
        display: flex; align-items: center; justify-content: center; position: relative;
      }
      .mic-btn:hover { transform: scale(1.05); }
      .mic-btn.listening {
        background: var(--asa-teal); animation: pulse 1.5s infinite;
      }
      .mic-btn.processing {
        background: var(--asa-gold);
      }
      @keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(0, 126, 127, 0.7); }
        50% { box-shadow: 0 0 0 20px rgba(0, 126, 127, 0); }
      }
      .voice-transcript {
        max-height: 200px; overflow-y: auto; margin-top: 16px; padding: 12px;
        background: var(--asa-bg); border-radius: 8px; font-size: 14px;
      }
      .voice-msg { margin: 8px 0; padding: 8px; border-radius: 6px; }
      .voice-msg.user { background: #E0F2FE; text-align: right; }
      .voice-msg.assistant { background: #F0FDF4; }
      .voice-msg .time { font-size: 10px; color: #9CA3AF; margin-top: 4px; }
      .voice-actions { display: flex; gap: 8px; margin-top: 12px; }
      .voice-actions button { flex: 1; padding: 8px; font-size: 12px; }
      footer {
        margin-top: 40px;
        padding: 24px 16px;
        background: #fff;
        color: #667085;
        border-top: 1px solid rgba(0,0,0,0.06);
      }
      .links a { color: var(--asa-navy); text-decoration: none; }
      .links a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="brand">
          <img src="assets/asa-logo.png" alt="ASA Institute of Higher Education logo">
          <div>
            <h1 class="title">ASAHE â€” ASAâ€‘Bot Preview</h1>
            <p class="subtitle">Try the embedded assistant and review quick links below.</p>
          </div>
        </div>
      </div>
    </header>

    <main class="container">
      <div class="grid">
        <div class="card">
          <p><strong>Tip:</strong> Use the chat bubble (bottom-right) to open ASAâ€‘Bot.</p>
          <div class="chips">
            <a class="chip" href="https://asahe.edu.au/courses/" target="_blank" rel="noopener">Courses</a>
            <a class="chip" href="https://asahe.edu.au/admissions/" target="_blank" rel="noopener">How to apply</a>
            <a class="chip" href="https://asahe.edu.au/fees-and-refunds/" target="_blank" rel="noopener">Fees & refunds</a>
            <a class="chip" href="https://asahe.edu.au/international-students/" target="_blank" rel="noopener">International students</a>
            <a class="chip" href="https://asahe.edu.au/student-support/" target="_blank" rel="noopener">Student Support</a>
            <a class="chip" href="https://asahe.edu.au/contact-us/" target="_blank" rel="noopener">Contact</a>
          </div>
          <a class="cta" href="https://asahe.edu.au/" target="_blank" rel="noopener">Visit ASAHE website</a>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Quick actions</h3>
          <div class="actions">
            <button class="btn" id="btn-open-chat">Open ASAâ€‘Bot</button>
            <button class="btn" id="btn-voice">Voice Assistant</button>
            <button class="btn" id="btn-upload">Upload documents</button>
            <button class="btn primary" id="btn-intake">Start application</button>
          </div>
          <p class="help" style="margin-top:10px">No data leaves your browser in this demo; uploads and intake are stored locally until backend is connected.</p>
        </div>
      </div>
    </main>

    <!-- Intake Modal -->
    <div class="modal-backdrop hidden" id="modal-intake">
      <div class="modal">
        <h3>Start application</h3>
        <div class="row">
          <div>
            <label>First name *</label>
            <input id="in-first" required>
          </div>
          <div>
            <label>Last name *</label>
            <input id="in-last" required>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Email *</label>
            <input id="in-email" type="email" required>
          </div>
          <div>
            <label>Role *</label>
            <select id="in-role">
              <option value="student">Prospective student</option>
              <option value="agent">Education agent</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Programme *</label>
            <input id="in-programme" placeholder="e.g., Bachelor of Business">
          </div>
          <div>
            <label>Preferred intake</label>
            <input id="in-intake" placeholder="e.g., Feb 2026">
          </div>
        </div>
        <div class="row single">
          <label><input type="checkbox" id="in-consent"> I consent to the use of this information for ASAHE enrolment support.</label>
        </div>
        <div class="modal-actions">
          <button class="btn" data-close="#modal-intake">Cancel</button>
          <button class="btn primary" id="submit-intake">Save summary</button>
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal-backdrop hidden" id="modal-upload">
      <div class="modal">
        <h3>Upload documents (demo)</h3>
        <p class="help">Accepted now: any files for preview only. Processing will run serverâ€‘side later.</p>
        <input id="upload-input" type="file" multiple>
        <div id="upload-list" class="help" style="margin-top:8px"></div>
        <div class="modal-actions">
          <button class="btn" data-close="#modal-upload">Close</button>
          <button class="btn primary" id="save-upload">Save manifest</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Voice Assistant Panel -->
    <div class="voice-panel" id="voice-panel">
      <div class="voice-header">
        <h4>ðŸŽ¤ ASA Voice Assistant</h4>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
          <span class="voice-status" id="voice-status">Ready</span>
          <span id="storage-info" style="font-size:10px;color:#9CA3AF;">0 messages stored</span>
        </div>
        <button class="btn" style="padding:4px 8px;font-size:12px;" onclick="hideVoicePanel()">âœ•</button>
      </div>
      <div class="mic-container">
        <button class="mic-btn" id="mic-btn" title="Click to start listening">
          ðŸŽ¤
        </button>
      </div>
      <div class="voice-transcript" id="voice-transcript">
        <div class="voice-msg assistant">
          <div>Hello! I'm ASA Voice Assistant. Try saying:</div>
          <div style="margin-top:8px;font-size:12px;">â€¢ "What courses do you offer?"</div>
          <div style="font-size:12px;">â€¢ "Start my application"</div>
          <div style="font-size:12px;">â€¢ "Tell me about fees"</div>
          <div style="font-size:12px;">â€¢ "Open chat"</div>
          <div style="margin-top:12px;padding:8px;background:#FFF3CD;border-radius:6px;font-size:11px;color:#856404;">
            ðŸ’¡ <strong>Tip:</strong> When you click the mic, your browser will ask for microphone permission. Please allow it to use voice features.
          </div>
        </div>
      </div>
      <div class="voice-actions">
        <button class="btn" onclick="clearVoiceHistory()">Clear</button>
        <button class="btn" onclick="openChatFromVoice()">Open Chat</button>
        <button class="btn" onclick="viewLocalStorage()" style="font-size:11px;">View Storage</button>
      </div>
      <div style="font-size:11px;color:#6B7280;margin-top:8px;text-align:center;" id="storage-count">
        Messages in storage: <strong id="storage-num">0</strong>
      </div>
    </div>

    <footer>
      <div class="container links">
        ASAHE canonical links:
        <a href="https://asahe.edu.au/" target="_blank" rel="noopener">Home</a> Â·
        <a href="https://asahe.edu.au/about-us/" target="_blank" rel="noopener">About</a> Â·
        <a href="https://asahe.edu.au/student-portal/" target="_blank" rel="noopener">Student Portal</a>
      </div>
    </footer>

    <!-- Chatbase embed (as provided) -->
    <!-- 
      HOW IT WORKS:
      1. Creates a queue system to store API calls before Chatbase loads
      2. Uses Proxy to intercept method calls (like chatbase('open'))
      3. Dynamically loads Chatbase script after page is ready
      4. Bot ID (bVrB07H2M1k0K0bN59FGy) identifies your ASA-Bot
      5. Once loaded, processes queued commands and shows chat widget
      
      See CHATBASE_EMBED_EXPLAINED.md for full details
    -->
    <script>
      (function(){
        // Step 1: Create queue system for API calls before Chatbase loads
        if(!window.chatbase||window.chatbase("getState")!=="initialized"){
          // Queue function: stores calls in window.chatbase.q array
          window.chatbase=(...arguments)=>{if(!window.chatbase.q){window.chatbase.q=[]}window.chatbase.q.push(arguments)};
          // Proxy: intercepts method calls and queues them
          window.chatbase=new Proxy(window.chatbase,{get(target,prop){if(prop==="q"){return target.q}return(...args)=>target(prop,...args)}})
        }
        // Step 2: Function to load Chatbase script dynamically
        const onLoad=function(){
          const script=document.createElement("script");
          script.src="https://www.chatbase.co/embed.min.js"; // Chatbase CDN
          script.id="bVrB07H2M1k0K0bN59FGy"; // ASA-Bot widget id (identifies your bot)
          script.domain="www.chatbase.co";
          document.body.appendChild(script) // Triggers script download
        };
        // Step 3: Load after page is ready (non-blocking)
        if(document.readyState==="complete"){onLoad()} else { window.addEventListener("load",onLoad) }
      })();
    </script>
    <script>
      // Helpers
      const $ = (sel)=>document.querySelector(sel);
      function show(el){ el.classList.remove('hidden'); el.style.display='flex'; }
      function hide(el){ el.classList.add('hidden'); el.style.display='none'; }
      function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }

      // Quick actions
      $('#btn-open-chat')?.addEventListener('click',()=>{
        try { window.chatbase('open'); } catch(e) { /* fallback */ }
      });

      // ===== ADVANCED VOICE ASSISTANT =====
      const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
      const SpeechSynthesis = window.speechSynthesis;
      let voiceRecognition = null;
      let isListening = false;
      let shouldAutoRestart = false;
      let voiceHistory = JSON.parse(localStorage.getItem('asa.voice.history') || '[]');

      function showVoicePanel() {
        $('#voice-panel').classList.add('active');
        renderVoiceHistory();
        updateStorageCount();
      }

      function hideVoicePanel() {
        $('#voice-panel').classList.remove('active');
        stopListening();
      }

      function updateVoiceStatus(text, className = '') {
        const status = $('#voice-status');
        status.textContent = text;
        status.className = 'voice-status ' + className;
      }

      function addVoiceMessage(role, text, metadata = {}) {
        const msg = {
          role,
          text,
          time: new Date().toLocaleTimeString(),
          timestamp: new Date().toISOString(),
          id: 'msg_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9),
          ...metadata
        };
        voiceHistory.push(msg);
        localStorage.setItem('asa.voice.history', JSON.stringify(voiceHistory));
        console.log('ðŸ’¾ Saved to localStorage:', msg);
        console.log('ðŸ“Š Total messages stored:', voiceHistory.length);
        console.log('ðŸ’¿ Full localStorage data:', JSON.parse(localStorage.getItem('asa.voice.history') || '[]'));
        renderVoiceHistory();
        updateStorageCount();
      }

      function updateStorageCount() {
        const count = voiceHistory.length;
        const storageInfo = $('#storage-info');
        const storageNum = $('#storage-num');
        
        if (storageInfo) {
          storageInfo.textContent = `${count} message${count !== 1 ? 's' : ''} stored`;
        }
        if (storageNum) {
          storageNum.textContent = count;
        }
        
        // Also log to console
        const stored = localStorage.getItem('asa.voice.history');
        if (stored) {
          const parsed = JSON.parse(stored);
          const sizeKB = (stored.length / 1024).toFixed(2);
          console.log(`ðŸ“¦ Storage: ${parsed.length} messages, ${sizeKB} KB`);
          console.log('ðŸ“‹ All stored messages:', parsed);
        } else {
          console.log('ðŸ“¦ Storage: Empty');
        }
      }

      function viewLocalStorage() {
        const stored = localStorage.getItem('asa.voice.history');
        const data = stored ? JSON.parse(stored) : [];
        
        if (data.length === 0) {
          alert('No voice data stored yet. Try using the voice assistant first!');
          return;
        }
        
        const jsonStr = JSON.stringify(data, null, 2);
        
        // Show in console
        console.log('ðŸ“‹ Full localStorage data:');
        console.table(data);
        console.log('ðŸ“„ JSON:', jsonStr);
        
        // Show modal
        const modal = document.createElement('div');
        modal.className = 'modal-backdrop';
        modal.style.display = 'flex';
        modal.innerHTML = `
          <div class="modal" style="max-width:700px;max-height:80vh;overflow-y:auto;">
            <h3>ðŸ’¾ Voice Data Storage</h3>
            <p class="help">Total messages: <strong>${data.length}</strong> | Size: <strong>${(stored.length / 1024).toFixed(2)} KB</strong></p>
            <div style="max-height:400px;overflow-y:auto;background:#F7F7F7;padding:12px;border-radius:8px;margin:12px 0;">
              <pre style="margin:0;font-size:11px;white-space:pre-wrap;word-wrap:break-word;">${jsonStr}</pre>
            </div>
            <div class="modal-actions">
              <button class="btn" onclick="this.closest('.modal-backdrop').remove()">Close</button>
              <button class="btn primary" id="download-json-btn">Download JSON</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
        
        // Add download button handler
        const downloadBtn = modal.querySelector('#download-json-btn');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', () => {
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `asa-voice-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            toast('Downloaded!');
          });
        }
        
        toast(`Showing ${data.length} stored messages. Check console for table view.`);
      }

      function renderVoiceHistory() {
        const transcript = $('#voice-transcript');
        if (voiceHistory.length === 0) {
          transcript.innerHTML = '<div class="voice-msg assistant"><div>Hello! I\'m ASA Voice Assistant. Try saying commands like "What courses do you offer?" or "Start my application".</div><div style="margin-top:12px;padding:8px;background:#FFF3CD;border-radius:6px;font-size:11px;color:#856404;">ðŸ’¡ <strong>Tip:</strong> When you click the mic, your browser will ask for microphone permission. Please allow it to use voice features.</div></div>';
          updateStorageCount();
          return;
        }
        transcript.innerHTML = voiceHistory.map(msg => `
          <div class="voice-msg ${msg.role}">
            <div>${msg.text}</div>
            <div class="time">${msg.time}${msg.action ? ' â€¢ Action: ' + msg.action : ''}</div>
          </div>
        `).join('');
        transcript.scrollTop = transcript.scrollHeight;
        updateStorageCount();
      }

      function speakText(text) {
        if (!SpeechSynthesis) return;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-AU';
        utterance.rate = 0.95;
        utterance.pitch = 1;
        SpeechSynthesis.speak(utterance);
      }

      function parseVoiceCommand(text) {
        const lower = text.toLowerCase();
        
        // Commands
        if (lower.includes('open chat') || lower.includes('open bot')) {
          return { action: 'openChat', response: 'Opening ASA-Bot chat for you now.' };
        }
        if (lower.includes('start application') || lower.includes('apply') || lower.includes('begin application')) {
          return { action: 'startApplication', response: 'I\'ll help you start your application. Opening the form now.' };
        }
        if (lower.includes('upload') || lower.includes('document')) {
          return { action: 'upload', response: 'I can help you upload documents. Opening the upload panel.' };
        }
        if (lower.includes('course') || lower.includes('program')) {
          return { action: 'courses', response: 'ASAHE offers various courses. You can find details at asahe.edu.au/courses. Would you like me to open that page?' };
        }
        if (lower.includes('fee') || lower.includes('cost') || lower.includes('price')) {
          return { action: 'fees', response: 'For information about fees and refunds, visit asahe.edu.au/fees-and-refunds. Would you like me to open that?' };
        }
        if (lower.includes('international') || lower.includes('visa') || lower.includes('overseas')) {
          return { action: 'international', response: 'For international student information, check asahe.edu.au/international-students. I can open that for you.' };
        }
        if (lower.includes('support') || lower.includes('help') || lower.includes('contact')) {
          return { action: 'support', response: 'For student support, visit asahe.edu.au/student-support or contact us at asahe.edu.au/contact-us.' };
        }
        if (lower.includes('hello') || lower.includes('hi') || lower.includes('hey')) {
          return { action: 'greeting', response: 'Hello! I\'m ASA Voice Assistant. I can help with courses, applications, fees, and more. What would you like to know?' };
        }
        
        // Default response
        return { 
          action: 'general', 
          response: `I heard: "${text}". For detailed help, try asking about courses, applications, or fees. You can also open the chat for more assistance.` 
        };
      }

      function executeVoiceCommand(cmd) {
        switch(cmd.action) {
          case 'openChat':
            try { window.chatbase('open'); } catch(e){}
            break;
          case 'startApplication':
            show($('#modal-intake'));
            break;
          case 'upload':
            show($('#modal-upload'));
            break;
          case 'courses':
            window.open('https://asahe.edu.au/courses/', '_blank');
            break;
          case 'fees':
            window.open('https://asahe.edu.au/fees-and-refunds/', '_blank');
            break;
          case 'international':
            window.open('https://asahe.edu.au/international-students/', '_blank');
            break;
          case 'support':
            window.open('https://asahe.edu.au/student-support/', '_blank');
            break;
        }
      }

      function startListening() {
        if (!SpeechRec) {
          toast('Voice recognition not supported in this browser. Try Chrome or Edge.');
          return;
        }
        if (isListening) return;

        // Check if getUserMedia is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          toast('Microphone access not available. Please use HTTPS or localhost.');
          updateVoiceStatus('Microphone not available', '');
          return;
        }

        // Request microphone permission first
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then((stream) => {
            // Stop the stream immediately - we just needed permission
            stream.getTracks().forEach(track => track.stop());
            // Permission granted, proceed with recognition
            startRecognition();
          })
          .catch((err) => {
            console.error('Microphone permission denied:', err);
            updateVoiceStatus('Microphone permission required', '');
            toast('Please allow microphone access and try again. Click the mic icon in your browser address bar.');
            $('#mic-btn').classList.remove('listening', 'processing');
            $('#mic-btn').textContent = 'ðŸŽ¤';
            isListening = false;
            shouldAutoRestart = false;
          });
      }

      function startRecognition() {
        isListening = true;
        voiceRecognition = new SpeechRec();
        voiceRecognition.lang = 'en-AU';
        voiceRecognition.continuous = true;
        voiceRecognition.interimResults = true;

        voiceRecognition.onstart = () => {
          updateVoiceStatus('Listening...', 'listening');
          $('#mic-btn').classList.add('listening');
          $('#mic-btn').textContent = 'ðŸ”´';
        };

        voiceRecognition.onresult = (e) => {
          let interim = '';
          let final = '';
          let confidence = 0;
          let finalConfidence = 0;
          
          for (let i = e.resultIndex; i < e.results.length; i++) {
            const result = e.results[i];
            const transcript = result[0].transcript;
            const conf = result[0].confidence || 0;
            
            if (result.isFinal) {
              final += transcript + ' ';
              finalConfidence = conf;
            } else {
              interim += transcript;
              confidence = conf;
            }
          }

          // Log interim results for debugging
          if (interim) {
            console.log('ðŸŽ¤ Interim:', interim, 'Confidence:', confidence);
          }

          if (final.trim()) {
            shouldAutoRestart = false; // Temporarily disable auto-restart during processing
            if (voiceRecognition) {
              voiceRecognition.stop();
            }
            isListening = false;
            const text = final.trim();
            
            console.log('âœ… Final transcript:', text);
            console.log('ðŸ“Š Confidence:', finalConfidence);
            
            // Store user message with confidence
            addVoiceMessage('user', text, { 
              confidence: finalConfidence,
              rawTranscript: text
            });
            
            $('#mic-btn').classList.remove('listening');
            $('#mic-btn').classList.add('processing');
            $('#mic-btn').textContent = 'âš™ï¸';
            updateVoiceStatus('Processing...', 'processing');

            setTimeout(() => {
              const cmd = parseVoiceCommand(text);
              console.log('ðŸŽ¯ Parsed command:', cmd);
              
              // Store assistant response with action metadata
              addVoiceMessage('assistant', cmd.response, { 
                action: cmd.action, 
                userQuery: text,
                confidence: finalConfidence
              });
              
              executeVoiceCommand(cmd);
              speakText(cmd.response);
              
              $('#mic-btn').classList.remove('processing');
              $('#mic-btn').textContent = 'ðŸŽ¤';
              updateVoiceStatus('Ready');
              
              // Auto-restart listening after response if panel is still open
              if ($('#voice-panel').classList.contains('active')) {
                setTimeout(() => {
                  shouldAutoRestart = true;
                  startListening();
                }, 1500);
              }
            }, 500);
          }
        };

        voiceRecognition.onerror = (e) => {
          console.error('Voice recognition error:', e.error);
          let errorMsg = 'Error occurred. Click mic to retry.';
          
          if (e.error === 'not-allowed') {
            errorMsg = 'Microphone permission denied. Please allow access in browser settings.';
            toast('Please allow microphone access. Check your browser settings.');
          } else if (e.error === 'no-speech') {
            errorMsg = 'No speech detected. Try again.';
          } else if (e.error === 'network') {
            errorMsg = 'Network error. Check your connection.';
          } else if (e.error === 'aborted') {
            errorMsg = 'Recognition aborted.';
            return; // Don't show error for manual stop
          }
          
          updateVoiceStatus(errorMsg);
          stopListening();
        };

        voiceRecognition.onend = () => {
          if (shouldAutoRestart && $('#voice-panel').classList.contains('active')) {
            // Auto-restart if still in listening mode
            setTimeout(() => {
              if (shouldAutoRestart) startListening();
            }, 100);
          }
        };

        try {
          shouldAutoRestart = true;
          voiceRecognition.start();
        } catch(e) {
          console.error('Failed to start recognition:', e);
          isListening = false;
          shouldAutoRestart = false;
          updateVoiceStatus('Failed to start. Please try again.');
        }
      }

      function stopListening() {
        isListening = false;
        shouldAutoRestart = false;
        if (voiceRecognition) {
          voiceRecognition.stop();
          voiceRecognition = null;
        }
        $('#mic-btn').classList.remove('listening', 'processing');
        $('#mic-btn').textContent = 'ðŸŽ¤';
        updateVoiceStatus('Ready');
      }

      function clearVoiceHistory() {
        voiceHistory = [];
        localStorage.removeItem('asa.voice.history');
        renderVoiceHistory();
        updateStorageCount();
        toast('Voice history cleared');
      }


      function openChatFromVoice() {
        try { window.chatbase('open'); } catch(e){}
      }

      // Voice button handler
      $('#btn-voice')?.addEventListener('click', () => {
        showVoicePanel();
        setTimeout(() => startListening(), 300);
      });

      $('#mic-btn')?.addEventListener('click', () => {
        if (isListening) {
          stopListening();
        } else {
          startListening();
        }
      });

      // Initialize voice history on load
      renderVoiceHistory();
      updateStorageCount();
      
      // Log initial storage state
      console.log('ðŸŽ¤ Voice Assistant initialized');
      console.log('ðŸ“¦ Current storage:', voiceHistory.length, 'messages');
      if (voiceHistory.length > 0) {
        console.log('ðŸ“‹ Stored messages:', voiceHistory);
      }

      // Intake modal
      $('#btn-intake')?.addEventListener('click',()=> show($('#modal-intake')));
      document.querySelectorAll('[data-close]')?.forEach(btn=>btn.addEventListener('click', (e)=>{
        const sel = e.currentTarget.getAttribute('data-close'); hide($(sel));
      }));
      $('#submit-intake')?.addEventListener('click',()=>{
        const data = {
          first: $('#in-first').value.trim(),
          last: $('#in-last').value.trim(),
          email: $('#in-email').value.trim(),
          role: $('#in-role').value,
          programme: $('#in-programme').value.trim(),
          intake: $('#in-intake').value.trim(),
          consent: $('#in-consent').checked,
          createdAt: new Date().toISOString()
        };
        if(!data.first || !data.last || !data.email || !data.programme || !data.consent){ toast('Please complete required fields and consent.'); return; }
        const id = 'intake_' + Math.random().toString(36).slice(2,9);
        const summary = { id, ...data };
        const store = JSON.parse(localStorage.getItem('asa.intakes')||'[]'); store.push(summary); localStorage.setItem('asa.intakes', JSON.stringify(store));
        // Download JSON summary
        const blob = new Blob([JSON.stringify(summary,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = id + '.json'; a.click(); URL.revokeObjectURL(url);
        hide($('#modal-intake')); toast('Application saved locally.');
      });

      // Upload modal
      let stagedFiles = [];
      $('#btn-upload')?.addEventListener('click',()=>{ stagedFiles=[]; $('#upload-input').value=''; $('#upload-list').textContent=''; show($('#modal-upload')); });
      $('#upload-input')?.addEventListener('change',(e)=>{
        stagedFiles = Array.from(e.target.files||[]);
        $('#upload-list').textContent = stagedFiles.length ? stagedFiles.map(f=>`â€¢ ${f.name} (${Math.round(f.size/1024)} KB)`).join('\n') : '';
      });
      $('#save-upload')?.addEventListener('click',()=>{
        const manifest = {
          id: 'upload_' + Math.random().toString(36).slice(2,9),
          files: stagedFiles.map(f=>({ name:f.name, size:f.size })),
          createdAt: new Date().toISOString()
        };
        const store = JSON.parse(localStorage.getItem('asa.uploads')||'[]'); store.push(manifest); localStorage.setItem('asa.uploads', JSON.stringify(store));
        const blob = new Blob([JSON.stringify(manifest,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = manifest.id + '.json'; a.click(); URL.revokeObjectURL(url);
        hide($('#modal-upload')); toast('Upload manifest saved locally.');
      });
    </script>
  </body>
  </html>


